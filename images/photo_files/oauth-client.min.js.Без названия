!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define("@mail/oauth",["exports"],b):b((a="undefined"!=typeof globalThis?globalThis:a||self).MR={})}(this,function(a){"use strict";var b=function(){return(b=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c])Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a}).apply(this,arguments)},c=window;function d(){}function e(a,b){!function(a,b){var e,f=function(a){!a&&4!==e.readyState||(a=a||200!==e.status&&201!==e.status,f=d,e.onreadystatechange=null,b(!!a,e))};try{e=new c.XMLHttpRequest}catch(a){try{e=new c.ActiveXObject("Msxml2.XMLHTTP")}catch(a){try{e=new c.ActiveXObject("Microsoft.XMLHTTP")}catch(a){(e={readyState:4,status:-1}).open=e.send=d}}}e.onerror=function(a){e.onerror=null,f(a)};try{e.open("GET",a,!0),e.send(null),e.onreadystatechange=function(){f()}}catch(a){f(a)}}(a,function(a,c){if(a)b(a,null);else try{b(a,JSON.parse(c.responseText))}catch(a){b(a,null)}})}var f="https://stat.radar.imgsmail.ru/update?v=1&p=oauth2";function g(a){(new Image).src=f+"&t=jssdk&i="+a+":1"}var h="__mr_oauth2__";function i(a,b,c){try{var d=window.localStorage,e="".concat(h,".").concat(a),f="ttl_".concat(h,".").concat(a);if(1===arguments.length){var g=parseInt(d.getItem(f),10);if(!g||g>Date.now())return JSON.parse(d.getItem(e))}else 0<=c&&d.setItem(f,"".concat(Date.now()+1e3*c)),d.setItem(e,JSON.stringify(b))}catch(a){}return null}function j(a){return document.createElement(a)}function k(a,b){a.appendChild(b)}function l(a){try{a.parentNode.removeChild(a)}catch(a){}}function m(a,b){if(a)for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}var n=function(a,b){void 0===b&&(b="1.5s");for(var c="_".concat(Date.now()),d="".concat(c,"-spin"),e="",f=-146,g=0;f<=92;f+=2)e+='<use fill="rgb('.concat(g+=2,",").concat(g,",").concat(g,')" xlink:href="#a" transform="rotate(').concat(f,' 32 32)"/>');return"\n\t<style>\n\t.".concat(c," {\n\t\twidth: 64px;\n\t\theight: 64px;\n\t\tdisplay: inline-block;\n\t\t-webkit-animation: ").concat(d," ").concat(b," linear infinite;\n\t\t-moz-animation: ").concat(d," ").concat(b," linear infinite;\n\t\tanimation: ").concat(d," ").concat(b," linear infinite;\n\t}\n\t@-moz-keyframes ").concat(d," { 100% { -moz-transform: rotate(360deg); } }\n\t@-webkit-keyframes ").concat(d," { 100% { -webkit-transform: rotate(360deg); } }\n\t@keyframes ").concat(d,' { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }\n\t</style>\n\t<div class="').concat(c,'"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 64 64">\n\t\t<defs>\n\t\t\t<path id="a" d="M0 0h32v32H0z"></path>\n\t\t\t<mask id="progress">\n\t\t\t\t<path d="M0 0h64v64H0z"></path>\n\t\t\t\t').concat(e,'\n\t\t\t</mask>\n\t\t</defs>\n\t\t<path fill="').concat(a,'" d="M54.6 47.6c-1.98-1.98-5.09-1.98-7.07 0-8.56 8.56-22.6 8.56-31.1 0-8.56-8.56-8.56-22.6 0-31.1 4.54-5.58-3.25-10.7-7.07-7.07-12.4 12.4-12.4 32.8 0 45.3 12.4 12.4 32.8 12.4 45.3 0 1.98-1.98 1.98-5.09 0-7.07zM32 54c-12.1 0-22-9.9-22-22s9.9-22 22-22c2.8 0 5-2.2 5-5s-2.2-5-5-5C14.4 0 0 14.4 0 32s14.4 32 32 32c7.16-.736 5.26-9.84 0-10z" mask="url(#progress)">\n\t\t</path>\n\t</svg></div>\n').trim()},o="unknown",p="connected",q="not_authorized",r="default",s="onetap",t="hidden",u="embedded",v="ru-RU",w="userinfo",x="mail.phone",y="full-fit",z="mailru-login-button",A="login";a.OAUTH_HOST="https://o2.mail.ru";var B="2147483647",C="2147483646",D="__mailru_oauth_".concat(Date.now(),"_").concat(Math.random(),"__"),E="".concat(location.protocol,"//").concat(location.host),F={ui:1,type:1,lang:1,auth:!1},G=/^data-/,H=/^on(load|error|(?:before)?click|login|logout)$/,I=/^https?:/,J=/[?&]lang=([^a-z_-]+)/i,K={},L=[],M=[],N=[],O="o2_mail_ru_popup_login",P=490,Q=500,R=490,S=20,T="close_state",U="login_state",V=1,W=!1,X={clientId:null},Y=window,$=Y.document,Z={btn:"jsapi/button",login:"login",logout:"jsapi/logout",userinfo:"userinfo"},_=[],aa=!1,ba=!1,ca=!1,da=null,ea=null,fa=null,ga=null,ha=o,ia=null,ja=null,ka=[];function la(a,b){return"".concat(a,":").concat(b)}function ma(a,b,c,d){var e=la(a,b);if(K.hasOwnProperty(e)||(K[e]=[]),d){var f=function(){!function(a,b,c){var d=la(a,b);if(K.hasOwnProperty(d)){var e=K[d].indexOf(c);-1<e&&K[d].splice(e,1)}}(a,b,f),c.apply(null,arguments)};K[e].push(f)}else K[e].push(c)}function na(b,c){var d="".concat(Z[b])+"?client_id=".concat(X.clientId)+"&redirect_uri=".concat(E)+(c.lang?"":"&lang=".concat(X.lang));return X.recaptcha,I.test(d)||(d="".concat(a.OAUTH_HOST,"/").concat(d)),"".concat(d,"&").concat(function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&"function"!=typeof c&&null!=a[c]&&(b+="&".concat(encodeURIComponent(c),"=").concat(encodeURIComponent(a[c])));return b.substr(1)}(c))}function oa(a){Ba("call logout"),ha=ha===p?q:o,ea=ja=ia=null,ka.forEach(function(a){a.send("auth",ha)});var b=sa(!0);ta(a,b),ta(X.onlogin,b),ta(X.onlogout,b),i(U,null)}function pa(){Ba("globalOnLogin invoked"),function(){var a=sa(),b=a.user;Ba("refresh all prorts",a),ka.forEach(function(c){c.send("auth",a.status),b&&c.send("auth:user",b)})}(),ta(X.onlogin,sa())}function qa(a,b){function c(a){function c(){pa(),da.close(),ta(M,sa()),ca=!1,ea=null,M.length=0}Ba("login resolved",{ok:a,options:b}),a&&!1!==b.userinfo?ra(c):c()}if(void 0===b&&(b={}),null==b.mode&&(b.mode=r),Ba("call login",{options:b,authUser:!!ia}),ia)ta(a,sa());else{if(a&&M.push(a),ca)return;if(fa){try{fa.close()}catch(a){}fa=null,Y.clearInterval(ga)}da=function(a){var b=V++,c=function(a){var b=a.mode;return b===s&&!aa||b===u&&!ba}(a),d=ua(c,b,a),e="popup_".concat(c?"embedded_":"").concat(a.mode,"_");{return Ba("openPortal",{id:b,embedded:c,options:a}),c?function(a){var b=a.id,c=a.loginUrl,d=a.radarPrefix,e=a.options;Ba("open embedded portal:",b,c,d,e);var f=j("div"),h=j("div"),i=j("iframe"),o=ya(b,i,{embedded:!0,root:f,onClose:function(){l(h)}}),p=Da(),q=p<=R+2*S,t=q?S/2:S,v=q?p-2*t:R,w=Ea()-2*t,x=e.mode===u;i.src=c,i.frameBorder="no",i.width=v+"",i.height="10",i.scrolling="no",m(i,{transform:"translate(0) scale(1,1)"}),m(f,{width:"".concat(i.width,"px"),height:"10px",position:"fixed",opacity:"0",borderRadius:"4px",transform:"translate(0, 20px)",boxShadow:"rgba(0,0,0,.16) 0 4px 20px",zIndex:B,overflow:"hidden",background:"#fff",pointerEvents:"none"}),x?(m(f,{top:"50%",left:"50%"}),m(h,{left:"0",top:"0",right:"0",bottom:"0",position:"fixed",zIndex:C,background:"rgba(0,0,0,.5)",display:"flex",alignItems:"center",justifyContent:"center"}),h.innerHTML='<div style="width: 64px; height: 64px">'.concat(n("#fff"),"</div>")):m(f,{top:"".concat(t,"px"),right:"".concat(t,"px")});k(f,i),k($.body,h),k($.body,f),g("".concat(d,"try_open")),o.on("connect",function(){g("".concat(d,"connected")),da.send("connected",{})});var y=null,z=function(a){var b,c=[],d=!1;function e(a){a(b)}return a(function(a){d||(b=a,d=!0,c.forEach(e),c.length=0)}),{then:function(a){d?e(a):c.push(a)}}}(function(a){o.on("repaint",function(b){var c=b.rect,d=da.el,e=d.parentElement,f=Math.min(c.height,w);100<c.height&&(d.height=f+"",d.width=v+"",d.scrolling=c.height>w?"yes":"no",m(e,{width:"".concat(v,"px"),height:"".concat(d.height,"px")}),(y=function(a){a&&m(e,{marginTop:"-".concat(f/2,"px"),marginLeft:"-".concat(v/2,"px")})})(x),a())})});return o.on("ready",function(a){var b=a.hidden;g("".concat(d,"ready")),g("".concat(d,"ready_hidden_").concat(b));function c(a){return z.then(function(){if(!k){var b=x?".6s ease-out":".25s";return y(x),a&&a.position?"center"===a.position?(m(f,{top:"50%",left:"50%"}),y(!0)):(m(f,{top:a.position.top,left:a.position.left}),y(!1)):y(x),i.getBoundingClientRect(),h.textContent="",m(f,{pointerEvents:"",opacity:"1",transform:"translate(0, 0)",transition:"transform ".concat(b,", opacity ").concat(b)}),va(e),setTimeout(function(){m(f,{transition:"height .15s ease-out"})},1e3),!0}Aa("Can't show OneTap, because it already closed (it's zombie)")})}function j(){return z.then(function(){if(!k)return k=!0,o.simulate("cancel"),!0;Aa("OneTap is already closed (it's zombie)")})}var k=!1;if(b)xa(e);else{var l=!1;xa(e,function(){return l=!0,{show:c,close:j}}),l||c()}}),o.on("open:login",function(a){var b=a.email;g("".concat(d,"open_login")),o.close(),qa(null,{email:b,embedded:ca=!1})}),o.on("unavailable",function(a){var b=a.mode;g("".concat(d,"unavailable_").concat(b)),b===s&&(aa=!(ca=!1),X.mode=r,X.autoLogin=!1),ta(X.onunavailable,{mode:e.mode}),o.close()}),o}({id:b,loginUrl:d,options:a,radarPrefix:e}):ea?(Ba("using proxy port",b),g("".concat(e,"_create_proxy_port")),va(a),ya(b,{postMessage:function(a){ea.send("login:proxy",a)}},{embedded:c})):(Ba("create popup portal",b),g("".concat(e,"_create_popup")),va(a),fa=function a(b){try{return Y.open(d,b,Fa())}catch(c){return"_blank"!==b?a("_blank"):null}}(O),ga=Y.setInterval(function(){try{if(!fa.top||fa.closed)throw"Y"}catch(a){Ca(b,"login:closed",{}),Y.clearInterval(ga)}},100),ya(b,fa,{embedded:!1}))}}(b),ca=!0,da.embedded?(da.on("cancel",function(){ca=!1,Ba("embedded portal[login] canceled"),i(T,!0,X.ttlCloseState),g("popup_embedded_".concat(b.mode,"_canceled")),c(!1),wa(b)}),L.push(function(){Ba("embedded portal[login] resolved"),c(!0)})):(ea||da).on("login:closed",function(){Ba("portal[login] closed"),g("popup_".concat(b.mode,"_closed_proxy")),c(!0),wa(b)})}}function ra(a){ia?a(ia):(N.push(a),1===N.length&&e(na("userinfo",{access_token:ja}),function(a,b){!function(a){return!(a&&a.hasOwnProperty("error"))}(b)||(ia=b,ha=p),ta(N,ia),N.length=0}))}function sa(a){return{status:ha,user:a?null:ia,access_token:a?null:ja}}function ta(a,b){if(a instanceof Array)a.forEach(function(a){ta(a,b)});else try{a&&a.call(null,b)}catch(a){Aa(a.stack)}}function ua(a,b,c){return na("login",{scope:X.scopes.join(" "),response_type:"token",embedded:a?"Y":null,mode:c.mode,state:JSON.stringify({cid:b,loginState:i(U),ttlLoginState:X.ttlLoginState,skin:X.skin||"default",txtExp:X.txtExp||"default"}),login:c.email})}function va(a){ta(X.onshow,{mode:a.mode})}function wa(a){ta(X.onclose,{mode:a.mode})}function xa(a,b){ta(X.onready,{mode:a.mode,onetap:b?{capture:b}:void 0})}function ya(b,c,d){var e=d.root||c,f={el:c,embedded:d.embedded,root:e,send:function(d,e){var f=JSON.stringify({cid:b,type:d,detail:e});Ba("[port] send: ".concat(d,", detail:"),e);try{c.contentWindow.postMessage(f,a.OAUTH_HOST)}catch(d){try{c.postMessage(f,a.OAUTH_HOST)}catch(d){}}},simulate:function(a,c){void 0===c&&(c={}),Y.postMessage(JSON.stringify({cid:b,type:a,detail:c}),"*")},on:function(a,c,d){return c&&ma(b,a,c,d),this},close:function(){this.send("login:close",{}),l(e),function(a){var b=new RegExp("^".concat(la(a,"")));for(var c in K)b.test(c)&&delete K[c]}(b),ta(d.onClose,[]),e=c=null}};return Ba("[port] created: ".concat(b,", iframe: ").concat(c instanceof HTMLIFrameElement)),f}function za(a){if(a[D]!==D){a[D]=D,m(a,{position:"relative"});var b=function(a,b){var c=a.attributes.length;for(;c--;){var d=a.attributes[c],e=d.name,f=d.value,g=G.test(e)?e.substr(5):null;g&&(H.test(g)?(Y[f]||Aa("Callback '".concat(e,'="').concat(f,"\"' not found")),b[g]=Y[f]):F[g]&&(b[g]=f))}return b}(a,{cid:V++,type:A,ui:""}),c=j("iframe"),d=ya(b.cid,c,{embedded:!1});c.width="100%",c.height="100%",m(c,{display:"inline-block",verticalAlign:"middle",borderRadius:"2px",transition:"all .1s ease-out"});var e=function(){return d.send("login:cfg",{url:ua(!1,b.cid,{mode:r,modern:!0}),name:O,embedded:X.mode===u,width:P,height:Q,params:Fa()})};a.addEventListener("focusin",function(){e()}),a.addEventListener("mouseover",function(){e()}),a.addEventListener("touchstart",function(){e()}),d.on("load",function(a){Ba("port[button] loaded",b.cid),e(),ka.push(d),-1<b.ui.indexOf(y)&&d.on("resize",function(a){var b=a.width,d=a.height;c.width=b,c.height=d}),d.on("beforeclick",function(a){ka.forEach(function(a){a!==d&&a.send("login:close",{})}),ta(b.onbeforeclick,a)}),d.on("open:embedded",function(){Ba("port[button] invoke embedded login",b.cid),qa(null,{mode:u})}),d.on("click",function(a){ia?(g("button_logout_click"),oa(b.onlogout)):(g("button_login_click"),ea=d,qa(b.onlogin)),ta(b.onclick,a)}),g("button_onload_".concat(a.status)),ta(b.onload,a)},!0),c.onerror=function(){Aa("[transport] Internal error"),g("transport_error"),ta(b.onerror,sa(!0))},c.setAttribute("frameborder","0"),c.scrolling="no",k(a,c),c.src=na("btn",b),Ba("port[button] created",b)}}function Aa(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];_.push("warn",a)}function Ba(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];_.push("info",a)}function Ca(a,b,c){var d=la(a,b);K.hasOwnProperty(d)&&ta(K[d],c)}function Da(){return Y.innerWidth||$.documentElement.clientWidth}function Ea(){return Y.innerHeight||$.documentElement.clientHeight}function Fa(){var a=Y.screen,b=null!=Y.screenLeft?Y.screenLeft:a.left,c=null!=Y.screenTop?Y.screenTop:a.top,d=Da()||a.width,e=Ea()||a.height;return["scrollbars=no","left=".concat((d-P)/2+(parseInt(b,10)||0)),"top=".concat((e-Q)/2.3+(parseInt(c,10)||0)),"width=".concat(P),"height=".concat(Q)].join(",")}function Ga(b){var c=b.origin,d=b.data;if(""!==d&&c===a.OAUTH_HOST)try{Ba("message",d);var e=JSON.parse(d),f=e.cid,h=e.type,j=e.detail;switch(Ca(f,h,j),h){case"load":ha=j.status,g("message_load_auth_status_".concat(j.status));break;case"auth":g("message_auth_status_".concat(j.status)),function(a){ja=a||null,L.splice(0,1e6).forEach(function(a){a({status:ja?p:q,access_token:ja})}),ja&&X.ttlLoginState&&i(U,!0,X.ttlLoginState)}(j.access_token)}}catch(b){Aa(b.stack||b.message)}}setInterval(function(){ka=ka.filter(function(a){if(function(a){return"IFRAME"===a.nodeName}(a.el)){for(var b=a.el;b=b.parentNode;)if(b===$.body)return!0;return Ba("[gc] port removed:",a),!1}return!0})},3e4),a.AUTH_CONNECTED=p,a.AUTH_NOT_AUTHORIZED=q,a.AUTH_UNKNOWN=o,a.BUTTON_CLASSNAME=z,a.BUTTON_TYPE_LOGIN=A,a.LANG_EN="en-US",a.LANG_RU=v,a.MODE_DEFAULT=r,a.MODE_EMBEDDED=u,a.MODE_HIDDEN=t,a.MODE_ONETAP=s,a.MODE_XHR="xhr",a.SCOPE_CLOUD_API="cloud.api",a.SCOPE_CLOUD_DND="cloud.openapi.dnd",a.SCOPE_DOCS_VIEW="mail.api.documents.view",a.SCOPE_MAIL_IMAP="mail.imap",a.SCOPE_MAIL_PHONE=x,a.SCOPE_USER_INFO=w,a.UI_ALWAYS_LOGIN="always_login",a.UI_FULL_FIT=y,a.UI_LOGIN_AS="login_as",a.UI_USERPIC="userpic",a.__DEV__=function(a){},a.auth=function(a){var c=V++,d=j("iframe");Ba("call auth"),m(d,{visibility:"hidden",position:"absolute",left:"-999px",top:"-999px"}),u===X.mode?L.push(function(b){var c=-1!==X.scopes.indexOf(w);l(d),b.status===p?c?ra(function(){Ba("auth successfully with userinfo",sa()),ta(a,sa()),pa()}):(Ba("auth successfully",b),ta(a,b),pa()):(Aa("User not authorized:",b),qa(a,{userinfo:c,mode:u}))}):L.push(a);var e=X.login;d.src=na("login",b(b({scope:X.scopes.join(" ")},e&&{login:e}),{response_type:"token",mode:t,state:"cid=".concat(c,"&e=").concat(D)})),k($.body,d)},a.getRuntimeLog=function(){return _},a.getState=function(){return sa()},a.getUser=ra,a.init=function(a){if(W)Ba("reinit",a);else{if(Ba("init",a),!a)throw new Error("[MR.init] `options` not defined");if(W=!0,!(X=a).clientId)throw new Error("[MR.init] `options.clientId` not defined");null==a.lang&&(a.lang=(Y.location.toString().match(J)||[])[1]||Y.navigator.language||Y.navigator.languages&&Y.navigator.languages[0]||v),Ba("[button] lang: ".concat(a.lang," (nav: ").concat(Y.navigator.language,", [").concat(Y.navigator.languages,"]")),null==a.scopes&&(a.scopes=[w]),null==a.modern&&(a.modern=-1<a.scopes.indexOf(x)||-1<location.toString().indexOf("o2.modern")),null==a.mode&&(a.mode=r),null==a.ttlCloseState&&(a.ttlCloseState=2592e3),null==a.ttlLoginState&&(a.ttlLoginState=a.mode===s?604800:0),a.mode===s&&(!i(T)||a.ttlCloseState<=0)&&(Ba("onetap autologin"),qa(null,{mode:s})),Y.addEventListener("message",Ga,!1)}!function(a){var b=$.getElementsByClassName(z),c=b.length;for(;c--;)a(b[c])}(za)},a.login=qa,a.logout=oa,a.reset=function(){i(T,null),i(U,null)},a.setOAuthHost=function(b){a.OAUTH_HOST=b},Object.defineProperty(a,"__esModule",{value:!0})});